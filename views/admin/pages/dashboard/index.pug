extends ../../layouts/default.pug
include ../../mixins/alert.pug

block main
    +showAlertSuccess(4000)
    +showAlertError(4000)

    //- Header
    .d-flex.align-items-center.mb-4
        h1.h3.mb-0.me-3 Bảng điều khiển
        span.badge.bg-primary.fw-normal PX Admin

    //- Helpers
    - const _num = v => (typeof v === 'number' && isFinite(v)) ? v : 0
    - const S = (typeof statistic === 'object' && statistic) ? statistic : { productCategory:{}, product:{}, account:{}, user:{} }
    - const safePct = (a,b)=> (b ? Math.round((a/b)*100) : 0)
    - const pcT = _num(S.productCategory.total), pcA = _num(S.productCategory.active)
    - const pT  = _num(S.product.total),            pA  = _num(S.product.active)
    - const adT = _num(S.account.total),            adA = _num(S.account.active)
    - const usT = _num(S.user.total),               usA = _num(S.user.active)
    - const pcAP = safePct(pcA, pcT)
    - const pAP  = safePct(pA,  pT)
    - const adAP = safePct(adA, adT)
    - const usAP = safePct(usA, usT)

    - const _rev = (typeof revenue === 'object' && revenue) ? revenue : {}
    - const rToday = _num(_rev.today)
    - const rWeek = _num(_rev.week)
    - const rMonth = _num(_rev.month)
    - const rPrevMonth = _num(_rev.prevMonth)
    - const rYear = _num(_rev.year)
    - const deltaMonth = rMonth - rPrevMonth
    - const pctDeltaMonth = rPrevMonth ? ((deltaMonth / rPrevMonth) * 100).toFixed(1) : '0.0'
    - const pctLabel = (deltaMonth >= 0 ? '+' : '') + pctDeltaMonth
    - const barMonth = rPrevMonth ? Math.min(100, Math.max(0, (rMonth / rPrevMonth) * 100)) : (rMonth ? 100 : 0)
    - const fmtVND = n => _num(n).toLocaleString('vi-VN')

    //- Top KPIs
    .row.g-3
        .col-6.col-xl-3
            .card.border-0.shadow-sm.position-relative.h-100
                .card-body
                    small.text-uppercase.text-muted.mb-1.d-block Danh mục
                    h4.mb-0 #{pcT}
                    .mt-2
                        .progress(style="height:6px;")
                            .progress-bar.bg-primary(style=`width:${pcAP}%`)
                    small.text-muted #{pcAP}% hoạt động
        .col-6.col-xl-3
            .card.border-0.shadow-sm.h-100
                .card-body
                    small.text-uppercase.text-muted.mb-1.d-block Sản phẩm
                    h4.mb-0 #{pT}
                    .mt-2
                        .progress(style="height:6px;")
                            .progress-bar.bg-success(style=`width:${pAP}%`)
                    small.text-muted #{pAP}% hoạt động
        .col-6.col-xl-3
            .card.border-0.shadow-sm.h-100
                .card-body
                    small.text-uppercase.text-muted.mb-1.d-block Admin
                    h4.mb-0 #{adT}
                    .mt-2
                        .progress(style="height:6px;")
                            .progress-bar.bg-warning(style=`width:${adAP}%`)
                    small.text-muted #{adAP}% hoạt động
        .col-6.col-xl-3
            .card.border-0.shadow-sm.h-100
                .card-body
                    small.text-uppercase.text-muted.mb-1.d-block Client
                    h4.mb-0 #{usT}
                    .mt-2
                        .progress(style="height:6px;")
                            .progress-bar.bg-info(style=`width:${usAP}%`)
                    small.text-muted #{usAP}% hoạt động

    //- Revenue overview
    .row.g-4.mt-1
        .col-12
            .card.h-100.shadow-sm
                .card-header.bg-white.d-flex.align-items-center.justify-content-between
                    .d-flex.align-items-center
                        i.bi.bi-cash-coin.text-primary.me-2
                        span.fw-semibold Thống kê doanh thu
                    span.badge.bg-light.text-dark
                        i.bi.bi-calendar3.me-1
                        | Tháng này
                .card-body
                    .row.g-3
                        .col-12.col-lg-4
                            .p-3.border.rounded
                                .d-flex.align-items-center.justify-content-between
                                    .d-flex.align-items-center
                                        .rounded-3.bg-success.bg-opacity-10.text-success.d-flex.align-items-center.justify-content-center(style="width:44px;height:44px;")
                                            i.bi.bi-cash-stack.fs-5
                                        .ms-3
                                            small.text-uppercase.text-muted.mb-1.d-block Doanh thu tháng
                                            h4.mb-0 #{fmtVND(rMonth)} ₫
                                    if rPrevMonth
                                        span.badge(class= deltaMonth>=0 ? 'bg-success' : 'bg-danger')
                                            i(class= deltaMonth>=0 ? 'bi bi-graph-up-arrow me-1' : 'bi bi-graph-down-arrow me-1')
                                            | #{pctLabel}%
                                .mt-3
                                    .progress(style="height:6px;")
                                        .progress-bar.bg-success(style=`width:${barMonth}%;`)
                                    small.text-muted.d-block.mt-1 So với tháng trước: #{fmtVND(rPrevMonth)} ₫
                        .col-12.col-lg-8
                            .row.g-3
                                .col-6.col-xl-3
                                    .card.border-0.shadow-sm.h-100
                                        .card-body
                                            .d-flex.align-items-center.justify-content-between
                                                small.text-uppercase.text-muted Hôm nay
                                                i.bi.bi-calendar-day.text-secondary
                                            h5.mb-0.mt-1 #{fmtVND(rToday)} ₫
                                .col-6.col-xl-3
                                    .card.border-0.shadow-sm.h-100
                                        .card-body
                                            .d-flex.align-items-center.justify-content-between
                                                small.text-uppercase.text-muted Tuần này
                                                i.bi.bi-calendar-week.text-secondary
                                            h5.mb-0.mt-1 #{fmtVND(rWeek)} ₫
                                .col-6.col-xl-3
                                    .card.border-0.shadow-sm.h-100
                                        .card-body
                                            .d-flex.align-items-center.justify-content-between
                                                small.text-uppercase.text-muted Tháng trước
                                                i.bi.bi-calendar-month.text-secondary
                                            h5.mb-0.mt-1 #{fmtVND(rPrevMonth)} ₫
                                .col-6.col-xl-3
                                    .card.border-0.shadow-sm.h-100
                                        .card-body
                                            .d-flex.align-items-center.justify-content-between
                                                small.text-uppercase.text-muted Năm nay
                                                i.bi.bi-calendar3-event.text-secondary
                                            h5.mb-0.mt-1 #{fmtVND(rYear)} ₫

    //- Content grid
    .row.g-4.mt-1
        //- Left: breakdowns
        .col-12.col-lg-8
            .row.g-4
                .col-12.col-md-6
                    .card.h-100.shadow-sm
                        .card-header.bg-white.fw-semibold Danh mục sản phẩm
                        .card-body
                            ul.list-group.list-group-flush.small
                                li.list-group-item.d-flex.justify-content-between
                                    span Tổng
                                    b #{pcT}
                                li.list-group-item.d-flex.justify-content-between
                                    span Hoạt động
                                    span.text-success #{pcA}
                                li.list-group-item.d-flex.justify-content-between
                                    span Dừng
                                    span.text-danger #{_num(S.productCategory.inactive)}
                .col-12.col-md-6
                    .card.h-100.shadow-sm
                        .card-header.bg-white.fw-semibold Sản phẩm
                        .card-body
                            ul.list-group.list-group-flush.small
                                li.list-group-item.d-flex.justify-content-between
                                    span Tổng
                                    b #{pT}
                                li.list-group-item.d-flex.justify-content-between
                                    span Hoạt động
                                    span.text-success #{pA}
                                li.list-group-item.d-flex.justify-content-between
                                    span Dừng
                                    span.text-danger #{_num(S.product.inactive)}
                .col-12.col-md-6
                    .card.h-100.shadow-sm
                        .card-header.bg-white.fw-semibold Tài khoản admin
                        .card-body
                            ul.list-group.list-group-flush.small
                                li.list-group-item.d-flex.justify-content-between
                                    span Tổng
                                    b #{adT}
                                li.list-group-item.d-flex.justify-content-between
                                    span Hoạt động
                                    span.text-success #{adA}
                                li.list-group-item.d-flex.justify-content-between
                                    span Dừng
                                    span.text-danger #{_num(S.account.inactive)}
                .col-12.col-md-6
                    .card.h-100.shadow-sm
                        .card-header.bg-white.fw-semibold Tài khoản client
                        .card-body
                            ul.list-group.list-group-flush.small
                                li.list-group-item.d-flex.justify-content-between
                                    span Tổng
                                    b #{usT}
                                li.list-group-item.d-flex.justify-content-between
                                    span Hoạt động
                                    span.text-success #{usA}
                                li.list-group-item.d-flex.justify-content-between
                                    span Dừng
                                    span.text-danger #{_num(S.user.inactive)}

        //- Right: account + actions
        .col-12.col-lg-4
            .card.h-60.shadow-sm
                .card-header.bg-white.fw-semibold Thông tin tài khoản
                .card-body
                    .d-flex.align-items-start
                        if user && user.avatar
                            img(src=user.avatar alt="Avatar" class="rounded me-3" style="width:72px;height:72px;object-fit:cover;")
                        else
                            .rounded.bg-secondary.bg-opacity-25.me-3.d-flex.align-items-center.justify-content-center(
                                style="width:72px;height:72px;"
                            )
                                span.text-secondary.fw-semibold #{(user && user.fullName && user.fullName[0]) || 'U'}
                        .flex-grow-1
                            if user && user.fullName
                                h5.mb-1 #{user.fullName}
                            if user && user.email
                                small.d-block.text-muted #{user.email}
                            if user && user.phone
                                small.d-block.text-muted #{user.phone}
                            if role && role.title
                                span.badge.bg-info.mt-2 #{role.title}
                    hr
                    ul.list-unstyled.mb-0.small
                        li.d-flex.justify-content-between
                            span ID
                            code #{user && user._id}
                        li.d-flex.justify-content-between.mt-1
                            span Trạng thái
                            if user && user.status=='active'
                                span.badge.bg-success Active
                            else
                                span.badge.bg-secondary Inactive
            .card.mt-4.shadow-sm
                .card-header.bg-white.fw-semibold Tác vụ nhanh
                .card-body
                    .d-grid.gap-2
                        //- a.btn.btn-primary.btn-sm(href=`${prefixAdmin}/products/create`)
                        //-     i.bi.bi-plus-lg.me-1
                        //-     | Thêm sản phẩm
                        //- a.btn.btn-outline-primary.btn-sm(href=`${prefixAdmin}/products-category/create`)
                        //-     i.bi.bi-collection.me-1
                        //-     | Thêm danh mục
                        if (role.permissions.includes('carts_management'))
                            form(
                                method="POST"
                                action=`${prefixAdmin}/carts/cleanup?_method=DELETE`
                                onsubmit="return confirm('Xác nhận xoá giỏ hàng vô chủ?');"
                            )
                                button(type="submit" class="btn btn-outline-danger btn-sm w-100")
                                    i.bi.bi-trash.me-1
                                    | Xoá giỏ hàng vô chủ